# 키움 OpenAPI+ 자동매매 프로그램 개발 현황 및 계획 (콘솔 기반)

## 프로젝트 개요
본 프로젝트는 키움 OpenAPI+를 이용하여 자동매매 프로그램을 개발하는 것을 목표로 합니다. 초기에는 PyQt5를 이용한 GUI 프로그램으로 개발되었으나, 반복적인 구동 테스트 실패 및 안정성 문제로 인해 현재 **콘솔(CLI) 기반 애플리케이션으로 전환**되었습니다. 사용자가 설정 파일 또는 향후 구현될 콘솔 명령을 통해 관심종목을 관리하고, 특정 조건에 따라 자동으로 매수하며, 설정된 조건(익절, 손절, 트레일링 스탑)에 따라 매도하는 전략을 구현합니다.

## 현재 상태 요약 (YYYY-MM-DD 기준)

*   **반복된 실제 프로그램 구동 테스트 실패 상황**:
    *   GUI 환경에서의 잦은 프리징 현상과 특정 기능 (예: 관심종목 정보 표시) 오류로 인해 안정적인 테스트 및 사용에 어려움이 있었습니다.
    *   이로 인해 디버깅 및 원인 파악에 많은 시간이 소요되었고, 프로젝트 진행에 영향을 주었습니다.

*   **GUI 포기 및 콘솔 기반으로 변경 현황**:
    *   안정성 확보와 핵심 로직 집중을 위해 GUI 대신 콘솔(CLI) 환경에서 실행되는 프로그램으로 구조를 변경했습니다.
    *   `main.py`: `ui.MainWindow` 관련 코드를 제거하고, 콘솔 환경에서 모듈들을 초기화하고 실행하도록 수정되었습니다. `signal.signal(signal.SIGINT, signal_handler)`를 통해 Ctrl+C로 프로그램을 종료하는 로직이 추가되었습니다.
    *   `strategy.py`: UI 연동을 위한 PyQt 시그널(`pyqtSignal`) 정의 및 관련 코드 (예: `stock_data_updated.emit()`)가 제거되거나 주석 처리되었습니다. 정보 전달은 주로 로깅을 통해 이루어집니다.
    *   `ui.py`: 파일은 존재하나, 현재 `main.py`에서 호출되지 않아 실제 프로그램 실행에는 영향을 주지 않습니다. 기존 `pm.md`의 UI 관련 마일스톤은 GUI 개발 시점의 기록이며, 현재는 콘솔 환경에 맞춰 기능이 재검토/구현되고 있습니다.
    *   `kiwoom_api.py`: 프로그램 프리징 현상의 주요 원인으로 지목된 `time.sleep()` 대신 `QApplication.processEvents()`를 사용하는 비차단 대기 함수 `non_blocking_sleep_using_process_events`로 대체하여 응답성 개선을 시도했습니다.

*   **현재 프로그램에 사용된 전략 세부사항** (`strategy.py` 기반):
    *   **상태 관리**: `TradingState` (IDLE, WAITING, READY, BOUGHT, PARTIAL_SOLD, COMPLETE) 열거형을 사용하여 종목별 매매 상태를 관리합니다.
    *   **매수 조건**:
        *   기본 조건: `today_open_higher_than_yesterday_close` (당일 시가 > 전일 종가) 플래그와 `price_above_open` (현재가 > 당일 시가) 조건을 확인합니다. (pm.md 초기 조건에서 "전일 종가 하회 후 돌파" 부분은 현재 코드에서 명시적으로 확인되지 않음)
        *   매수 실행: `execute_buy` 메소드를 통해 시장가 주문을 시도합니다. 주문 성공 시 `order_sent_flags`에 요청명을 기록하고, 실제 체결은 `on_chejan_data_received`에서 처리합니다.
    *   **매도 조건**:
        *   손절: 매수가 대비 설정 파일(`settings.json`)의 `손절_손실률` (기본값: 3.0%) 이상 하락 시 전량 시장가 매도.
        *   익절 (1차): 매수가 대비 설정 파일의 `익절_수익률` (기본값: 5.0%) 이상 상승 시, 설정된 `익절_매도비율` (기본값: 50%) 만큼 시장가 매도. 상태는 `PARTIAL_SOLD`로 변경.
        *   트레일링 스탑 (익절 2차): `PARTIAL_SOLD` 상태에서, 당일 고점 또는 부분 매도 후 고점 대비 설정 파일의 `트레일링_하락률` (기본값: 2.0%) 이상 하락 시 전량 시장가 매도.
    *   **설정**: 매수금액, 각종 매매 비율 및 시간 등은 `config.py`의 `ConfigManager`를 통해 `settings.json` 파일에서 로드 및 관리됩니다.
    *   **주문 관리**: `order_sent_flags`를 사용하여 중복 주문을 방지하려 시도합니다. 실제 체결 및 상태 변경은 `on_chejan_data_received` 콜백 함수에서 처리됩니다.

*   **현재 프로그램 구동시 예상 문제점 및 우려 사항**:
    *   **프리징 현상**: `non_blocking_sleep_using_process_events`로 변경 후에도 장시간 또는 복잡한 상황에서의 안정성은 추가 검증이 필요합니다.
    *   **콘솔 환경에서의 정보 확인**: GUI가 없어 모든 정보(관심종목 실시간 가격, 계좌 상태, 매매 신호 등)를 로그를 통해 확인해야 하므로, 가독성 및 실시간 대응에 제약이 있을 수 있습니다. `strategy.py`의 `get_watchlist_data_for_display` 및 `get_portfolio_data_for_display` 등이 로깅 목적으로 사용됩니다.
    *   **TR 요청 제한 및 화면 번호 관리**: `util.py`에 `ScreenManager` 클래스가 도입되어 화면 번호 관리를 시도하고 있으나, 다수 종목 동시 처리 또는 매우 빈번한 API 요청 발생 시 여전히 화면 번호 부족 또는 TR 제한(초당 5회, 1분에 100회 등)에 직면할 가능성이 있습니다. 이 부분에 대한 스트레스 테스트 및 예외 처리가 중요합니다.
    *   **데이터 정확성 및 동기화**: API로부터 수신하는 데이터(특히 잔고, 체결 정보)와 프로그램 내부 상태 간의 정확한 동기화가 중요합니다. `on_tr_data_received` 및 `on_chejan_data_received`에서의 처리가 핵심입니다.
    *   **오류 처리**: 네트워크 오류, API 자체 오류, 데이터 파싱 오류 등 다양한 예외 상황에 대한 처리가 아직 부족할 수 있습니다. 각 모듈에서의 `try-except` 블록과 로깅을 강화해야 합니다.

*   **앞으로 개선방향에 대한 의견**:
    *   **콘솔 인터페이스 강화**: 현재는 프로그램 실행 후 Ctrl+C로 종료하는 방식이지만, 간단한 명령(예: 관심종목 추가/제거, 상태 확인, 설정 변경 등)을 입력받을 수 있는 콘솔 인터페이스를 구현하거나, 설정 파일 변경을 감지하여 동적으로 설정을 리로드하는 기능을 고려할 수 있습니다.
    *   **안정성 최우선 확보**: 장시간 운영 테스트를 통해 메모리 누수, 예상치 못한 종료, API 요청 오류 등을 지속적으로 모니터링하고 수정해야 합니다. 특히 `ScreenManager`와 TR 요청 간격 관리 로직의 견고성을 높여야 합니다.
    *   **전략 유연성 및 확장성**: 현재 하드코딩된 전략 외에, 다양한 기술적 지표(이동평균선, MACD, RSI 등)를 조합하거나 사용자가 전략 요소를 쉽게 변경/추가할 수 있는 구조를 고려해볼 수 있습니다. (예: 전략 설정 파일 분리)
    *   **상세 로깅 및 모니터링**: 중요한 매매 결정 과정, 오류 발생 지점, API 요청/응답 내용을 더욱 상세히 기록하고, 필요한 경우 외부 알림(예: 특정 조건 발생 시 이메일/메신저 알림) 기능을 추가하여 사용자가 프로그램 상태를 원격으로도 파악할 수 있도록 합니다.
    *   **백테스팅 기능 구현**: `pm.md` 초기 계획에 포함된 백테스팅 기능을 구현하여, 과거 데이터를 기반으로 현재 전략의 수익성 및 안정성을 검증하고 파라미터를 최적화하는 과정을 거치는 것이 중요합니다.
    *   **데이터 검증 및 예외 처리 강화**: API로부터 수신하는 모든 데이터(특히 숫자형 가격, 수량)에 대해 `_safe_int`, `_safe_float` 외에도 추가적인 유효성 검증 및 방어 코드를 강화하여 데이터 오류로 인한 오작동을 최소화해야 합니다.

## 마일스톤 및 작업 태스크 (콘솔 기반으로 재조정)

(기존 마일스톤 내용을 기반으로 하되, UI 관련 부분은 "콘솔 환경으로 대체" 또는 "N/A" 등으로 수정/표기하고, 콘솔 환경에 맞는 태스크를 추가/조정할 필요가 있습니다. 아래는 기존 내용을 유지하되, 주석으로 현재 상황을 반영합니다.)

### 마일스톤 1: 개발 환경 설정 및 기본 구조 구축 ✅ (완료)
- **태스크 1.1 ~ 1.3**: 완료 (콘솔 환경에 맞게 로거 등 기능 유지)

### 마일스톤 2: API 연결 및 데이터 처리 ✅ (부분 수정 후 완료)
- **태스크 2.1: 키움 API 연결 클래스 구현 (kiwoom_api.py)**
    - **수정 사항**: `time.sleep()`을 `non_blocking_sleep_using_process_events`로 변경하여 프리징 개선 시도. `util.ScreenManager` 사용을 위한 구조 변경 가능성.
- **태스크 2.2: 종목 정보 요청 및 처리 기능 구현**
    - **완료 내용**: TR 요청 제한 처리 로직(`comm_rq_data` 내) 및 화면 번호 관리(`ScreenManager` 연동) 포함.
- **태스크 2.3: 실시간 데이터 처리 기능 구현**
    - **수정 사항**: UI 시그널 대신 내부 로직 처리 및 로깅 중심으로 변경.

### 마일스톤 3: 사용자 인터페이스 및 관심종목 관리 🔄 (콘솔 환경으로 재설계)
- **참고**: 기존 GUI (`ui.py`) 코드는 현재 메인 프로그램(`main.py`)에서 사용되지 않음.
- **태스크 3.1: 메인 UI 프레임워크 구현 (ui.py)**
    - **현황**: 해당 GUI 코드는 존재하나, 콘솔 앱에서는 미사용. (문서상 완료 표기는 유지하되, 주석으로 명시)
- **태스크 3.2: 관심종목 관리 기능 구현**
    - **현황**: `Database` 연동은 유지. GUI 대신 설정 파일(`settings.json` 내 `Watchlist` 섹션) 또는 향후 구현될 콘솔 명령으로 관심종목 관리. `strategy.py`에서 `add_to_watchlist`, `remove_from_watchlist` 등이 DB와 연동되어야 함. (현재 `main.py`에서 설정파일 기반 로드)
- **태스크 3.3: 설정 UI 및 대시보드 구현**
    - **현황**: GUI 설정 탭 및 대시보드는 미사용. 설정은 `settings.json` 파일을 통해 직접 관리. 대시보드 정보는 로그를 통해 확인.

### 마일스톤 4: 매매 전략 및 주문 실행 ✅ (핵심 로직 구현 완료, 안정화 필요)
- **태스크 4.1: 매매 전략 로직 구현 (strategy.py)**
    - **완료 내용**: 위에 기술된 "현재 프로그램에 사용된 전략 세부사항" 참조. UI 시그널 부분은 제거.
- **태스크 4.2: 주문 기능 구현**
    - **완료 내용**: `KiwoomAPI.send_order` 및 `TradingStrategy`의 체결 데이터 처리 로직 (`on_chejan_data_received`) 구현. `ScreenManager`와 연동된 화면 번호 사용.
- **태스크 4.3: 백테스팅 및 전략 검증 (선택사항)**
    - **현황**: 아직 구현되지 않음. (향후 중요 개선 과제)

### 마일스톤 5: 시스템 통합 및 안정화 ⏳ (진행 중)
- **태스크 5.1: 시스템 통합 및 메인 프로그램 구현 (main.py)**
    - **완료 내용**: 콘솔 기반으로 변경된 `main.py` 구현 완료.
- **태스크 5.2: 테스트 및 디버깅**
    - **현황**: 단위 테스트 및 통합 테스트는 기존 GUI 기반에서 작성된 부분이 있을 수 있으며, 콘솔 환경에 맞게 재검토 및 보강 필요. 특히 장시간 구동 테스트 및 예외 상황(API 오류, 네트워크 불안정 등)에 대한 테스트 집중 필요.
- **태스크 5.3: 프로그램 안정화 및 문서화**
    - **현황**: 안정화 작업 계속 진행 중. 이 `pm.md` 문서가 그 일부.

### 마일스톤 6: 대체거래소 대응 및 기능 확장 (선택사항)
- **현황**: 아직 계획 단계.

## 일정 및 리소스 계획
(기존 내용 유지, 필요시 업데이트)

## 평가 및 검증 기준
- **기능 완성도**: 콘솔 환경에서 모든 핵심 기능(로그인, 계좌정보 조회, 관심종목 관리, 실시간 데이터 수신, 설정 기반 자동 매매, 주문 및 체결 처리, 로깅)이 구현되었는지 확인.
- **안정성**: 장시간 운영 시 오류 없이 동작하는지, 특히 API 요청 제한 및 화면 번호 관리가 안정적인지 확인. 예외 상황 발생 시 프로그램이 비정상 종료되지 않고 적절히 대응하는지 확인.
- **성능**: 실시간 데이터 처리 및 주문 실행 지연이 없는지, 시스템 리소스를 과도하게 사용하지 않는지 확인.
- **사용성 (콘솔)**: 로그 가독성, 설정 파일(`settings.json`)을 통한 설정 변경 용이성, (향후 구현 시) 콘솔 명령의 직관성.
- **확장성**: 새로운 매매 전략이나 기능을 추가하기 용이한 구조인지 확인.

## 프로젝트 완료 기준 (콘솔 기반으로 조정)
1.  모든 필수 마일스톤(1~5, 콘솔 환경 기준)이 완료됨.
2.  모든 핵심 기능이 테스트되고 안정적으로 동작함 (특히 장시간 자동매매 시나리오).
3.  프로그램이 실제 모의투자 환경에서 최소 일주일 이상 안정적으로 운영됨.
4.  주요 설정 방법 및 실행 방법, 로그 확인 방법 등을 포함한 사용자 가이드 (간단한 README.md 형태라도) 및 개발 관련 주요 내용이 이 `pm.md`에 기록됨.

