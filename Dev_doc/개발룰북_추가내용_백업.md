# 개발룰북 추가내용 (2024년 12월)

## 11. 매매 시스템 핵심 로직

### 11.1 중복 매수 방지 시스템

#### 11.1.1 3단계 방어 시스템
```
1차 방어: 포트폴리오 보유량 확인 (_handle_waiting_state)
 - 실제 계좌 포트폴리오에서 보유수량 확인
 - 0보다 크면 매수 차단

2차 방어: 매수 체결 횟수 확인 (execute_buy)
 - stock_info.buy_completion_count 확인
 - max_buy_attempts_per_stock 설정값과 비교

3차 방어: 상태 플래그 확인 (execute_buy)
 - TradingState.BOUGHT, PARTIAL_SOLD, COMPLETE 상태 확인
 - 해당 상태시 매수 차단
```

#### 11.1.2 매수 체결 완료 시점 정의
**중요**: `buy_completion_count`는 **완전체결 시에만** 증가
```python
# ✅ 올바른 구현 (strategy.py)
if stock_info.strategy_state != TradingState.BOUGHT:
    stock_info.buy_completion_count += 1  # 첫 매수 체결시에만 증가
    stock_info.strategy_state = TradingState.BOUGHT
```

### 11.2 StockTrackingData 일관성 확보

#### 11.2.1 종목코드 정규화 규칙
```python
def _normalize_stock_code(self, code):
    """A접두사 제거 정규화"""
    if not code:
        return ""
    normalized = str(code).strip()
    if normalized.startswith('A') and len(normalized) > 1:
        normalized = normalized[1:]
    return normalized
```

#### 11.2.2 정규화 적용 지점
- **저장 시**: `add_to_watchlist()` - 입력 코드 정규화 후 저장
- **체결 데이터 처리**: `on_chejan_data_received()` - 정규화 후 검색
- **전략 실행**: `process_strategy()` - 정규화된 코드로 검색

#### 11.2.3 StockTrackingData 접근 실패 대응
```python
# 1단계: 정규화된 코드로 재검색
if not stock_info and code != normalized_code:
    stock_info = self.watchlist.get(normalized_code)

# 2단계: 포트폴리오에서 자동 복구
if not stock_info:
    stock_info = self._recover_missing_stock_from_portfolio(code)

# 3단계: 긴급 중복매수 차단
if not stock_info and code in portfolio and holding_quantity > 0:
    self.log("EMERGENCY_STOP: StockTrackingData 없지만 포트폴리오 보유", "CRITICAL")
    return  # 매수 차단
```

### 11.3 부분체결 처리 규칙

#### 11.3.1 미체결 수량 기반 체결량 계산
```python
# ❌ 잘못된 방식 (FID 911 사용)
last_filled_qty = self._safe_to_int(chejan_data.get("911"))

# ✅ 올바른 방식 (미체결량 차이 계산)
previous_unfilled_qty = active_order_entry_ref.get('unfilled_qty', original_order_qty)
current_unfilled_qty = unfilled_qty  # FID 902
last_filled_qty = previous_unfilled_qty - current_unfilled_qty
```

#### 11.3.2 임시 주문 수량 관리
- **매도 주문 접수시**: 포트폴리오 임시 주문 수량 증가
- **부분 체결시**: 체결량만큼 임시 주문 수량 감소
- **주문 완료시**: 임시 주문 수량 완전 초기화

### 11.4 상태 전이 규칙

#### 11.4.1 TradingState 전이도
```
WAITING → BOUGHT (첫 매수 체결시)
BOUGHT → PARTIAL_SOLD (부분 매도시)
PARTIAL_SOLD → BOUGHT (잔량 유지시)
BOUGHT/PARTIAL_SOLD → WAITING (전량 매도시, reset_stock_strategy_info 호출)
Any → COMPLETE (최대 시도 횟수 도달시)
```

#### 11.4.2 상태별 처리 로직
- **WAITING**: 매수 조건 확인 및 매수 실행
- **BOUGHT**: 매도 조건 확인 (손절, 익절, 트레일링 스탑)
- **PARTIAL_SOLD**: 잔량에 대한 매도 조건 확인
- **COMPLETE**: 더 이상 매수 시도 없음

### 11.5 개발 시 필수 검증 사항

#### 11.5.1 코드 수정 전 체크리스트
- [ ] 수정이 3단계 중복매수 방지 시스템을 파괴하지 않는가?
- [ ] StockTrackingData 접근 로직의 일관성이 유지되는가?
- [ ] 종목코드 정규화가 모든 관련 함수에 적용되었는가?
- [ ] 매수 체결 완료 카운팅 로직이 올바른가?

#### 11.5.2 매매 로직 변경 시 특별 주의사항
- **절대 원칙**: 잘 작동하는 중복매수 방지 로직 건드리지 말 것
- **검증 필수**: 포트폴리오와 StockTrackingData 동기화 확인
- **테스트 항목**: 부분체결, 완전체결, 매수실패 시나리오 모두 확인

## 12. 중복 매수 문제 해결 사례 (2024년 12월)

### 12.1 문제 상황
- **증상**: 044490 종목 등에서 4회 중복 매수 발생
- **원인**: "StockTrackingData가 작동에 실패했다" 로그 반복 확인
- **결과**: 중복매수 방지 시스템 전체 우회

### 12.2 근본 원인 분석
#### 12.2.1 StockTrackingData 접근 실패
```python
# 문제점: process_strategy에서 early return
def process_strategy(self, code):
    stock_info = self.watchlist.get(code)
    if not stock_info:
        # ⚠️ 여기서 return되면 모든 중복매수 방지 로직 우회!
        return
    # ... 실제 매수 방지 로직들
```

#### 12.2.2 종목코드 정규화 불일치
- **체결 데이터**: 'A005930' 형태로 수신
- **watchlist 저장**: '005930' 형태로 저장
- **결과**: 코드 매칭 실패로 StockTrackingData 접근 불가

### 12.3 해결책 적용
1. **종목코드 정규화 통일**: 모든 지점에서 `_normalize_stock_code()` 사용
2. **StockTrackingData 복구 로직**: 포트폴리오 기반 자동 복구
3. **긴급 차단 로직**: StockTrackingData 실패 시에도 중복매수 차단
4. **상세 로깅**: 실패 원인 추적을 위한 디버깅 정보 추가

### 12.4 예방책
- **일관성 검증**: 종목코드 정규화 로직 통일성 확인
- **접근 실패 모니터링**: StockTrackingData 접근 실패 빈도 추적
- **포트폴리오 동기화**: watchlist와 portfolio 간 동기화 확인

## 13. 협업 시 추가 지침

### 13.1 중요한 깨달음
1. **"실패하지 않도록 수정"이 우선**: 증상 치료보다 근본 원인 해결
2. **매수 체결 완료 시점 이해**: buy_completion_count는 완전체결시에만 증가
3. **종목코드 일관성**: 모든 지점에서 동일한 정규화 로직 적용

### 13.2 향후 개발 원칙
- **기존 작동 로직 보존**: 잘 작동하는 중복매수 방지 시스템 절대 건드리지 말 것
- **단계적 검증**: 수정 → 검증 → 다음 수정 순서 엄격히 준수
- **영향도 분석 필수**: 모든 수정이 다른 기능에 미치는 영향 사전 검토

---
*이 추가 내용은 기존 개발룰북.md에 통합되어야 함*